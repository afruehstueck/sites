<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="./css/StudyBrowser.css" media="screen" />

    <script src="./jslib/jquery-2.1.4.min.js"></script>
    <script src="./jslib/pouchdb-5.1.0.js"></script>
    <script src="./jslib/pouchdb.memory.js"></script>

    <script src="dicomMetadictionary.js"></script>

    <script>
      $(document).ready(function() {

        var segmentationDB = new PouchDB('http://quantome.org:5984/segmentation-server');
        var chronicleDB = new PouchDB('http://quantome.org:5984/chronicle');
        document.segmentationDB = segmentationDB;

        var requests = [];

        var simulateSegmentation = function(id) {
          segmentationDB.get(id).then(function(doc) {
            var times = [.1, .3, .6, .9];
            for (var index = 0; index < times.length; index++) {
              var progressDocument = {
                type : 'progress',
                requestID : id,
                progress : 'working'
              };
              setTimeout( function() {
                segmentationDB.post( progressDocument );
              }, 1000 * times[index]);
            }
            setTimeout( function() {
              segmentationDB.post({
                type : 'result',
                requestID : id,
                answer : 42
              });
            }, 1000);
          }).catch(function (err) {
            console.log(err);
          });
        }

        var requestFeed = segmentationDB.changes({
          since: 'now',
          live: true,
          include_docs: true
        }).on('change', function(change) {
          if (change.doc.algorithm == 'segment') {
            var changeString = change.id + ': ' + String(change.doc.seed);
            $('#requestTable').append('<li>' + changeString + '</li>');
            simulateSegmentation(change.id);
          }
        }).on('complete', function(info) {
          // changes() was canceled
        }).on('error', function (err) {
          console.log(err);
        });


        var progressFeed = segmentationDB.changes({
          since: 'now',
          live: true,
          include_docs: true
        }).on('change', function(change) {
          if (change.doc.type == 'progress') {
            var changeString = change.doc.requestID + ': ' + String(change.doc.progress);
            $('#progressTable').append('<li>' + changeString + '</li>');
          }
          if (change.doc.type == 'result') {
            var changeString = change.doc.requestID + ': Finished';
            $('#resultTable').append('<li>' + changeString + '</li>');
          }
        }).on('complete', function(info) {
          // changes() was canceled
        }).on('error', function (err) {
          console.log(err);
        });


        var makeRequest = function(event) {
          var request = {
            algorithm : 'segment',
            image : $('#sourceImage')[0].src,
            seed : [event.offsetX, event.offsetY],
          };
          segmentationDB.post(request).then(function(doc) {
            requests.push(doc.id);
          })
        };

        $('#sourceImage').mousedown(makeRequest);


        function datasetZPosition(dataset) {
          var imagePositionPatientTag = "00200032";
          var imagePositionPatient = dataset[imagePositionPatientTag];
          if (imagePositionPatient) {
            return JSON.parse(imagePositionPatient.Value.replace(/'/g, ""))[2];
          } else {
            return (0);
          }
        }

        var chURLPrefix = "http://quantome.org:5984";
        var key = [["UnspecifiedInstitution", "TCGA-50-8460"],
                   ["CT", "CT CHEST WITHOUT CONTR", "1.2.826.0.1.3680043.2.1125.1.58047104466126071866880070167552720"],
                   "1.2.826.0.1.3680043.2.1125.1.3504916618561857663178193880208876"];
        var endKey = [key.slice(0), {}];
        var sortedInstances = [];
        chronicleDB.query('instances/context', {
          start_key : key,
          end_key : endKey,
          reduce : true,
          group_level : 4,
          stale : 'update_after',
        }).then(function (result) {
          $.each(result.rows, function(index,row) {
            var instanceUID = row.key[3];
            var instanceURL = chURLPrefix + '/' + 'chronicle' + '/' + instanceUID;
            chronicleDB.get(instanceUID).then(function(doc) {
                sortedInstances.push(doc);
                sortedInstances.sort(function(a,b){return datasetZPosition(a.dataset)-datasetZPosition(b.dataset)});
                $('#instanceOffset')[0].max = sortedInstances.length;
                setSourceImage(sortedInstances.length-1);
            }).catch(function (err) {
              console.log('getInstance' + err);
            });
          });
        }).catch(function (err) {
          console.log(err);
        });

        function setSourceImage(offset) {
          var instance = sortedInstances[offset];
          var instanceUID = instance._id;
          var imageURL = chURLPrefix + '/' + 'chronicle' + '/' + instanceUID + '/image256.png';
          $('#sourceImage')[0].src = imageURL;
        }
        function updateImage() {
          offset = Number(document.getElementById('instanceOffset').value);
          setSourceImage(offset);
        }
        document.getElementById('instanceOffset').onchange = updateImage;
        document.getElementById('instanceOffset').oninput = updateImage;

        $('#instanceOffset').width(256);
      });


    </script>

    <title>Example Request Processing</title>

  </head>

<body>

<input type="range" min="0" max="3000" value="0" step="1" id="instanceOffset">
<br>
<img id="sourceImage"></img>

<h1>Requests</h1>
<ul id="requestTable">
</ul>

<h1>Progress</h1>
<ul id="progressTable">
</ul>

<h1>Results</h1>
<ul id="resultTable">
</ul>

</body>
</html>
