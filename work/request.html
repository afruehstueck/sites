<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="./css/StudyBrowser.css" media="screen" />

    <script src="./jslib/jquery-2.1.4.min.js"></script>
    <script src="./jslib/pouchdb-5.1.0.js"></script>
    <script src="./jslib/pouchdb.memory.js"></script>

    <script src="dicomMetadictionary.js"></script>

    <script>
      $(document).ready(function() {

        var db = new PouchDB('http://quantome.org:5984/segmentation-server');
        document.db = db;

        var requests = [];

        var simulateSegmentation = function(id) {
          db.get(id).then(function(doc) {
            var times = [.1, .3, .6, .9];
            for (var index = 0; index < times.length; index++) {
              var progressDocument = {
                type : 'progress',
                requestID : id,
                progress : 'working'
              };
              setTimeout( function() {
                db.post( progressDocument );
              }, 1000 * times[index]);
            }
            setTimeout( function() {
              db.post({
                type : 'result',
                requestID : id,
                answer : 42
              });
            }, 1000);
          }).catch(function (err) {
            console.log(err);
          });
        }

        var requestFeed = db.changes({
          since: 'now',
          live: true,
          include_docs: true
        }).on('change', function(change) {
          if (change.doc.algorithm == 'segment') {
            var changeString = change.id + ': ' + String(change.doc.seed);
            $('#requestTable').append('<li>' + changeString + '</li>');
            simulateSegmentation(change.id);
          }
        }).on('complete', function(info) {
          // changes() was canceled
        }).on('error', function (err) {
          console.log(err);
        });


        var progressFeed = db.changes({
          since: 'now',
          live: true,
          include_docs: true
        }).on('change', function(change) {
          if (change.doc.type == 'progress') {
            var changeString = change.doc.requestID + ': ' + String(change.doc.progress);
            $('#progressTable').append('<li>' + changeString + '</li>');
          }
          if (change.doc.type == 'result') {
            var changeString = change.doc.requestID + ': Finished';
            $('#resultTable').append('<li>' + changeString + '</li>');
          }
        }).on('complete', function(info) {
          // changes() was canceled
        }).on('error', function (err) {
          console.log(err);
        });


        var makeRequest = function(event) {
          var request = {
            algorithm : 'segment',
            image : $('#sourceImage')[0].src,
            seed : [event.offsetX, event.offsetY],
          };
          db.post(request).then(function(doc) {
            requests.push(doc.id);
          })
        };

        $('#sourceImage').mousedown(makeRequest);

      });


    </script>

    <title>Example Request Processing</title>

  </head>

<body>

<img id="sourceImage" src="../glimp/MRBrainTumor1_76.png"></img>

<h1>Requests</h1>
<ul id="requestTable">
</ul>

<h1>Progress</h1>
<ul id="progressTable">
</ul>

<h1>Results</h1>
<ul id="resultTable">
</ul>

</body>
</html>
